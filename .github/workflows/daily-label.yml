name: Daily PR Complexity Labeling

on:
  schedule:
    # Run at 1am UTC every day
    - cron: '0 1 * * *'
  workflow_dispatch:
    # Allow manual trigger with optional date range
    inputs:
      since:
        description: 'Start date (YYYY-MM-DD). Defaults to yesterday.'
        required: false
        type: string
      until:
        description: 'End date (YYYY-MM-DD). Defaults to same as start date.'
        required: false
        type: string
      force:
        description: 'Re-analyze PRs even if already labeled'
        required: false
        type: boolean
        default: false

jobs:
  label-prs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -e .

      - name: Calculate date range
        id: dates
        run: |
          # Set start date (since)
          if [ -n "${{ inputs.since }}" ]; then
            SINCE_DATE="${{ inputs.since }}"
          else
            # Default to yesterday
            SINCE_DATE=$(date -d "yesterday" +%Y-%m-%d)
          fi
          
          # Set end date (until)
          if [ -n "${{ inputs.until }}" ]; then
            UNTIL_DATE="${{ inputs.until }}"
          else
            # Default to same as start date
            UNTIL_DATE="$SINCE_DATE"
          fi
          
          echo "since=$SINCE_DATE" >> $GITHUB_OUTPUT
          echo "until=$UNTIL_DATE" >> $GITHUB_OUTPUT
          echo "Processing PRs from $SINCE_DATE to $UNTIL_DATE"

      - name: Label PRs with complexity
        env:
          # Use ORG_GITHUB_TOKEN (org-wide PAT) for accessing repos across the org
          GITHUB_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          FORCE_FLAG=""
          if [ "${{ inputs.force }}" = "true" ]; then
            FORCE_FLAG="--force"
          fi
          
          complexity-cli batch-analyze \
            --org your-org \
            --since ${{ steps.dates.outputs.since }} \
            --until ${{ steps.dates.outputs.until }} \
            --label \
            --workers 5 \
            $FORCE_FLAG

      - name: Summary
        if: always()
        run: |
          echo "## PR Complexity Labeling Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date range:** ${{ steps.dates.outputs.since }} to ${{ steps.dates.outputs.until }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Organization:** your-org" >> $GITHUB_STEP_SUMMARY

